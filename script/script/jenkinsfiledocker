pipeline {
    agent { label 'docker' }

    parameters {
        string(
            defaultValue: 'refs/heads/master',
            description: 'The Git reference used in checkout',
            name: 'GERRIT_REFSPEC'
        )
    }

    options {
        buildDiscarder(
            logRotator(
                artifactDaysToKeepStr: '',
                artifactNumToKeepStr: '',
                daysToKeepStr: '',
                numToKeepStr: '10'
            )
        )
        timestamps()
        timeout(time: 1, unit: 'HOURS')
    }

    triggers {
        gerrit(
            customUrl: '',
            gerritProjects:[
                [
                    branches: [
                        [
                            compareType: 'ANT',
                            pattern: '**'
                        ]
                    ],
                    compareType: 'PLAIN',
                    disableStrictForbiddenFileVerification: false,
                    pattern: 'internal_ddds'
                ]
            ],
            serverName: 'Talkamatic',
            triggerOnEvents: [
                patchsetCreated(
                    excludeDrafts: true,
                    excludeNoCodeChange: false,
                    excludeTrivialRebase: false
                )
            ],
            skipVote: [
              onSuccessful: false,
              onFailed    : false,
              onUnstable  : false,
              onNotBuilt  : false
            ]
        )
    }

    stages {
        stage('clean') {
            steps{
                step([$class: 'WsCleanup'])
            }
        }

        stage('checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [
                        [name: '$GERRIT_BRANCH']
                    ],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [
                        [
                            $class: 'BuildChooserSetting',
                            buildChooser: [
                                $class: 'GerritTriggerBuildChooser'
                            ]
                        ], [$class: 'RelativeTargetDirectory', relativeTargetDir: 'internal_ddds']
                    ],
                    submoduleCfg: [],
                    userRemoteConfigs: [[
                        credentialsId: 'jenkinsatgerrit',
                        refspec: '$GERRIT_REFSPEC',
                        url: 'ssh://jenkins@gerrit.talkamatic.se:29418/internal_ddds'
                    ]]
                ])
            }
        }

        stage('build & test ddds') {
            steps {
                script {
                    docker.withRegistry('https://registry.hub.docker.com', 'docker-hub-credentials') {
                        def tdm = docker.image('registry.hub.docker.com/talkamatic/tdm:master')
                        tdm.pull()
                        dir("internal_ddds") {
                            tdm.inside() {
                                stage('tide pooler') {
                                    sh 'tdm build --config tidePooler.json'
                                    sh 'tdm test eng --config tidePooler.json'
                                }

                                stage('multi ddd') {
                                    dir("multi_ddd") {
                                        sh 'tdm build'
                                        sh 'tdm test eng --interpret-robustly'
                                        sh 'tdm test sv'
                                    }
                                }

                                dir("rgl_migration") {
                                    stage('rgl migration without rgl') {
                                        dir("without_rgl") {
                                            sh 'tdm build'
                                            sh 'tdm test eng'
                                        }
                                    }

                                    stage('rgl migration with rgl') {
                                        dir("with_rgl") {
                                            stage('build & test android') {
                                                sh 'tdm build --config android.config.json'
                                                sh 'tdm test eng --config android.config.json --log-to-stdout'
                                                sh 'tdm test dut --config android.config.json --log-to-stdout'
                                                sh 'tdm test fre --config android.config.json --log-to-stdout'
                                                sh 'tdm test chi --config android.config.json --log-to-stdout'
                                            }

                                            stage('build & test device failure') {
                                                sh 'tdm build --config device_failure.config.json'
                                                sh 'tdm test eng --config device_failure.config.json --log-to-stdout'
                                                sh 'tdm test dut --config device_failure.config.json --log-to-stdout'
                                                sh 'tdm test fre --config device_failure.config.json --log-to-stdout'
                                                sh 'tdm test chi --config device_failure.config.json --log-to-stdout'
                                            }

                                            stage('build & test device notification') {
                                                sh 'tdm build --config device_notification.config.json'
                                                sh 'tdm test eng --config device_notification.config.json --log-to-stdout'
                                            }
                                        }
                                    }
                                }
                            }

                            stage('generate training data') {
                                tdm.inside() {
                                    sh 'tala generate rasa --config rasa_for_dynamic_entities.config.json rasa_for_dynamic_entities eng > rasa_for_dynamic_entities.yml'
                                    sh 'tala generate rasa --config rasa_for_static_entities.config.json rasa_for_static_entities eng > rasa_for_static_entities_eng.yml'
                                    sh 'tala generate rasa --config rasa_for_static_entities.config.json rasa_for_static_entities sv > rasa_for_static_entities_sv.yml'
                                    sh 'tala generate rasa --config rasa_strings.config.json rasa_strings eng > rasa_strings.yml'
                                    sh 'tala generate rasa --config rasa_answers.config.json rasa_answers eng > rasa_answers.yml'
                                    sh 'tala generate rasa --config rasa_for_rgl.config.json rasa_for_rgl eng > rasa_for_rgl.yml'
                                    sh 'tala generate rasa --config rasa_numbers.config.json rasa_numbers eng > rasa_numbers_eng.yml'
                                    sh 'tala generate rasa --config rasa_numbers.config.json rasa_numbers sv > rasa_numbers_sv.yml'
                                    sh 'tala generate rasa --config datetime.config.json datetime eng > datetime_eng.yml'
                                    sh 'tala generate rasa --config datetime.config.json datetime sv > datetime_sv.yml'
                                    sh 'tala generate rasa --config person_name.config.json person_name eng > person_name_eng.yml'
                                }
                            }

                            stage('rasa for dynamic entities') {
                                train("rasa_for_dynamic_entities", "rasa_for_dynamic_entities.yml")
                                load("rasa_for_dynamic_entities")
                                tdm.inside() {
                                    sh 'tdm build --config rasa_for_dynamic_entities.config.json'
                                    sh 'tdm test eng --config rasa_for_dynamic_entities.config.json --log-to-stdout'
                                }
                                unload("rasa_for_dynamic_entities")
                            }

                            stage('rasa for static entities') {
                                train("rasa_for_static_entities_eng", "rasa_for_static_entities_eng.yml")
                                load("rasa_for_static_entities_eng")
                                tdm.inside() {
                                    sh 'tdm build --config rasa_for_static_entities.config.json'
                                    sh 'tdm test eng --config rasa_for_static_entities.config.json --log-to-stdout'
                                }
                                unload("rasa_for_static_entities_eng")
                                train("rasa_for_static_entities_sv", "rasa_for_static_entities_sv.yml")
                                load("rasa_for_static_entities_sv")
                                tdm.inside() {
                                    sh 'tdm test sv --config rasa_for_static_entities.config.json --log-to-stdout'
                                }
                                unload("rasa_for_static_entities_sv")
                            }

                            stage('rasa strings') {
                                train("rasa_strings", "rasa_strings.yml")
                                load("rasa_strings")
                                tdm.inside() {
                                    sh 'tdm build --config rasa_strings.config.json'
                                    sh 'tdm test eng --config rasa_strings.config.json --log-to-stdout'
                                }
                                unload("rasa_strings")
                            }

                            stage('rasa answers') {
                                train("rasa_answers", "rasa_answers.yml")
                                load("rasa_answers")
                                tdm.inside() {
                                    sh 'tdm build --config rasa_answers.config.json'
                                    sh 'tdm test eng --config rasa_answers.config.json --log-to-stdout'
                                }
                                unload("rasa_answers")
                            }

                            stage('rasa for rgl') {
                                train("rasa_for_rgl", "rasa_for_rgl.yml")
                                load("rasa_for_rgl")
                                tdm.inside() {
                                    sh 'tdm build --config rasa_for_rgl.config.json'
                                    sh 'tdm test eng --config rasa_for_rgl.config.json --log-to-stdout'
                                }
                                unload("rasa_for_rgl")
                            }

                            stage('rasa numbers') {
                                use_duckling_config("rasa_numbers_eng.yml")
                                train("rasa_numbers_eng", "rasa_numbers_eng.yml")
                                load("rasa_numbers_eng")
                                tdm.inside() {
                                    sh 'tdm build --config rasa_numbers.config.json'
                                    sh 'tdm test eng --config rasa_numbers.config.json --log-to-stdout'
                                }
                                unload("rasa_numbers_eng")
                                use_duckling_config("rasa_numbers_sv.yml")
                                train("rasa_numbers_sv", "rasa_numbers_sv.yml")
                                tdm.inside() {
                                    sh 'tdm test sv --config rasa_numbers.config.json --log-to-stdout'
                                }
                                unload("rasa_numbers_sv")
                            }

                            stage('rasa time') {
                                use_duckling_config("datetime_eng.yml")
                                train("datetime_eng", "datetime_eng.yml")
                                tdm.inside() {
                                    sh 'tdm build --config datetime.config.json'
                                    sh 'tdm test eng --config datetime.config.json --log-to-stdout'
                                }
                                unload("datetime_eng")
                                use_duckling_config("datetime_sv.yml")
                                train("datetime_sv", "datetime_sv.yml")
                                tdm.inside() {
                                    sh 'tdm test sv --config datetime.config.json --log-to-stdout'
                                }
                                unload("datetime_sv")
                            }

                            stage('person name') {
                                use_spacy_entity_extractor_pipeline("person_name_eng.yml")
                                train("person_name_eng", "person_name_eng.yml")
                                tdm.inside() {
                                    sh 'tdm build --config person_name.config.json'
                                    sh 'FLASK_APP=person_name/http_service.py FLASK_ENV=development flask run --port=10101 &'
                                    sh 'tdm test eng --config person_name.config.json --log-to-stdout'
                                }
                                unload("person_name_eng")
                            }
                        }
                    }
                }
            }
        }
    }
}

def use_duckling_config(filename) {
    def trainingData = readFile filename
    def defaultPipeline = 'pipeline: "spacy_sklearn"'
    def ducklingPipeline = """pipeline:
- name: "SpacyNLP"
- name: "SpacyTokenizer"
- name: "RegexFeaturizer"
- name: "SpacyFeaturizer"
- name: "SklearnIntentClassifier"
- name: "DucklingHTTPExtractor"
  url: "http://duckling:8000"
"""
    writeFile file: filename, text: trainingData.replace(defaultPipeline, ducklingPipeline)
}

def use_spacy_entity_extractor_pipeline(filename) {
    def trainingData = readFile filename
    def defaultPipeline = 'pipeline: "spacy_sklearn"'
    def ducklingPipeline = """pipeline:
- name: "SpacyNLP"
- name: "SpacyTokenizer"
- name: "RegexFeaturizer"
- name: "SpacyFeaturizer"
- name: "CRFEntityExtractor"
- name: "EntitySynonymMapper"
- name: "SklearnIntentClassifier"
- name: "SpacyEntityExtractor"
"""
    writeFile file: filename, text: trainingData.replace(defaultPipeline, ducklingPipeline)
}

def load(model) {
    sh "curl --fail 'http://rasa-nlu-jenkins.cloud.talkamatic.se:5000/parse?project=internal_ddds&model=${model}&q=hello' > /dev/null 2>&1"
}

def unload(model) {
    sh "curl --fail -X DELETE 'http://rasa-nlu-jenkins.cloud.talkamatic.se:5000/models?project=internal_ddds&model=${model}'"
}

def train(model, training_data) {
    sh "curl --fail -X POST -H 'Content-Type: application/x-yml' 'http://rasa-nlu-jenkins.cloud.talkamatic.se:5000/train?project=internal_ddds&model=${model}' --data-binary @${training_data} > /dev/null 2>&1"
}
