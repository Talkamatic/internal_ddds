pipeline {
    agent { label 'tdm && docker' }

    options {
        buildDiscarder(
            logRotator(
                artifactDaysToKeepStr: '',
                artifactNumToKeepStr: '',
                daysToKeepStr: '',
                numToKeepStr: '10'
            )
        )
        timestamps()
        timeout(time: 1, unit: 'HOURS')
    }

    stages {
        stage('clean') {
            steps {
                step([$class: 'WsCleanup'])
            }
        }

        stage('checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/master']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'internal_ddds']],
                    submoduleCfg: [],
                    userRemoteConfigs: [[
                        credentialsId: 'jenkinsatgerrit',
                        url: 'ssh://jenkins@gerrit.talkamatic.se:29418/internal_ddds'
                    ]]
                ])
            }
        }

        stage('prepare') {
            steps {
                step([
                    $class: 'CopyArtifact',
                    filter: 'dist/*.whl',
                    projectName: 'tdm-nightly',
                    selector: [
                        $class: 'StatusBuildSelector',
                        stable: false
                    ],
                    target: 'artifacts'])

                sh '''#!/bin/bash -ex
                    virtualenv venv
                    echo "export PYTHONPATH=$PYTHONPATH:." >> venv/bin/activate
                '''
            }
        }

        stage('install tala') {
            steps {
                sh '''#!/bin/bash -ex
                    virtualenv venv
                    source venv/bin/activate

                    pip install artifacts/dist/tala*.whl
                '''
            }
        }

        stage('install tdm') {
            steps {
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    pip install artifacts/dist/tdm*.whl
                '''
            }
        }

        stage('build & test ddds') {
            failFast false
            parallel {
                stage('tide pooler') {
                    steps {
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds

                            tdm build --config tidePooler.json
                        '''
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds

                            tdm test eng --config tidePooler.json
                        '''
                    }
                }

                stage('multi ddd') {
                    steps {
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds/multi_ddd
                            tdm build
                        '''
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds/multi_ddd
                            tdm test eng --interpret-robustly
                        '''
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds/multi_ddd
                            tdm test sv
                        '''
                    }
                }

                stage('rgl migration without rgl') {
                    steps {
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds/rgl_migration/without_rgl
                            tdm build
                        '''
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds/rgl_migration/without_rgl
                            tdm test eng
                        '''
                    }
                }

                stage('rgl migration with rgl') {
                    stages {
                        stage('build & test android') {
                            steps {
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm build --config android.config.json
                                '''
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm test eng --config android.config.json
                                '''
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm test dut --config android.config.json
                                '''
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm test fre --config android.config.json
                                '''
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm test chi --config android.config.json
                                '''
                            }
                        }

                        stage('build & test device failure') {
                            steps {
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm build --config device_failure.config.json
                                '''
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm test eng --config device_failure.config.json
                                '''
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm test dut --config device_failure.config.json
                                '''
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm test fre --config device_failure.config.json
                                '''
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm test chi --config device_failure.config.json
                                '''
                            }
                        }

                        stage('build & test device notification') {
                            steps {
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm build --config device_notification.config.json
                                '''
                                sh '''#!/bin/bash -ex
                                    source venv/bin/activate

                                    cd internal_ddds/rgl_migration/with_rgl
                                    tdm test eng --config device_notification.config.json
                                '''
                            }
                        }
                    }
                }
            }
        }

        stage('install spacy models') {
            steps {
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    tdm download-spacy eng
                '''
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    tdm download-spacy sv
                '''

            }
        }

        stage('rasa for dynamic entities') {
            steps {
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm build --config rasa_for_dynamic_entities.config.json --rasa-config duckling_disabled.rasa.config.json
                '''
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm test eng --config rasa_for_dynamic_entities.config.json
                '''
            }
        }

        stage('rasa for static entities') {
            steps {
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm build --config rasa_for_static_entities.config.json --rasa-config duckling_disabled.rasa.config.json
                '''
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm test eng --config rasa_for_static_entities.config.json
                '''
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm test sv --config rasa_for_static_entities.config.json
                '''
            }
        }

        stage('rasa strings') {
            steps {
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm build --config rasa_strings.config.json --rasa-config duckling_disabled.rasa.config.json
                '''
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm test eng --config rasa_strings.config.json
                '''
            }
        }

        stage('rasa answers') {
            steps {
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm build --config rasa_answers.config.json --rasa-config duckling_disabled.rasa.config.json
                '''
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm test eng --config rasa_answers.config.json
                '''
            }
        }

        stage('rasa for rgl') {
            steps {
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm build --config rasa_for_rgl.config.json --rasa-config duckling_disabled.rasa.config.json
                '''
                sh '''#!/bin/bash -ex
                    source venv/bin/activate

                    cd internal_ddds

                    tdm test eng --config rasa_for_rgl.config.json
                '''
            }
        }

        stage('rasa numbers') {
            steps {
                script {
                    docker.image('rasa/duckling').withRun('-p 10090:8000') { c ->
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds

                            tdm build --config rasa_numbers.config.json --rasa-config duckling_enabled.rasa.config.json
                        '''
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds

                            tdm test eng --config rasa_numbers.config.json
                        '''
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds

                            tdm test sv --config rasa_numbers.config.json
                        '''
                    }
                }
            }
        }

        stage('rasa time') {
            steps {
                script {
                    docker.image('rasa/duckling').withRun('-p 10090:8000') { c ->
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds

                            tdm build --config rasa_time.config.json --rasa-config duckling_enabled.rasa.config.json
                        '''
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds

                            tdm test eng --config rasa_time.config.json
                        '''
                        sh '''#!/bin/bash -ex
                            source venv/bin/activate

                            cd internal_ddds

                            tdm test sv --config rasa_time.config.json
                        '''
                    }
                }
            }
        }
    }
}
